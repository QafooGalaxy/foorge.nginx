---
- name: "Install Nginx"
  apt: pkg=nginx-full

- name: "Remove default Nginx vhost"
  file: path=/etc/nginx/sites-enabled/{{ item }} state=absent
  with_items:
    - default
    - www.domain.de.conf.example
  notify: Restart Nginx

- name: "Create /etc/nginx/ssl directory"
  file: >
    path=/etc/nginx/ssl
    owner=root
    group=root
    mode=0640
    state=directory

- name: "Create self-signed SSL cert /etc/nginx/ssl/server.crt"
  command: >
     openssl req -new -nodes -x509 -subj "{{ nginx_selfsigned_subject }}" -days 3650 -keyout /etc/nginx/ssl/server.key -out /etc/nginx/ssl/server.crt -extensions v3_ca
     creates=/etc/nginx/ssl/server.crt
  notify: Restart Nginx

- name: Create Log-Directories
  file: >
    path=/var/log/{{ item.app }}/nginx
    state=directory
    owner={{ nginx_user }}
    group={{ nginx_user }}
    mode=0640
  with_items: nginx_hosts

- name: Generate Virtual Hosts
  template:
    src=backend_{{ item.backend_type|default('phpfpm') }}.j2
    dest=/etc/nginx/sites-enabled/{{ item.app }}.conf
    owner={{ nginx_user }}
    group={{ nginx_user }}
    mode=0644
  notify: Restart Nginx
  with_items: nginx_hosts

- name: Create conf.d configuration files
  template: src=config.conf.j2 dest=/etc/nginx/conf.d/{{ item }}.conf
  with_items: nginx_http_config.keys()
  notify: Restart Nginx

- name: Logrotate Rules for Nginx
  template: src=logrotate.j2 dest=/etc/logrotate.d/nginx-{{ item.app }}
  with_items: nginx_hosts

- name: Register Consul Service
  template: src=consul.j2 dest=/etc/consul.d/nginx.json
  register: nginx_consul_service

- name: Reload Consul
  command: consul reload
  when: nginx_consul_service|changed
